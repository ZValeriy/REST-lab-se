# Инструкция по настройке окружения для работы
В этом файле описаны шаги, которые нужно выполнить для комфортного выполнения работы на виртуальной машине (ВМ) Systems.Education
## Необходимое ПО и файлы конфигурации
### Visual Studio Code 
VS Code – текстовый редактор с множеством расширений для удобной работы с кодом и процессами разработки. Мы его будем использовать для написания необходимых для лабораторной работы скриптов.
#### Установка VS Code 
1. Скачайте VS Code [по ссылке](https://code.visualstudio.com/download)
1. Установите редактор
#### Установка расширений
1. Установите расширение [Remote - SSH](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh). С помощью него мы подключимся по SSH к ВМ и сможем работать с файлами так, будто они расположены локально.
1. Установите расширение [Container tools](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-containers). Это расширение упрощает работу с контейнерами, позволяет удобно читать их логи.
1. Установите расширение [OpenAPI (Swagger) Editor](https://marketplace.visualstudio.com/items?itemName=42Crunch.vscode-openapi). С ним вы сможете легко валидировать вашу спецификацию и смотреть на swaggerUI.
Вы можете установить эти расширения, перейдя во вкладку "Расширения" ("Extensions") в левом боковом меню (1 на скрине) и вбив в поисковкую строку (2) "Remote - SSH" (3), "Container Tools" (4) и "OpenAPI (Swagger) Editor" (5)
![Remote - SSH](./install_1.png)
![Container Tools](./install_2.png)
![OpenAPI (Swagger) Editor](./install_3.png)

### OpenVPN
OpenVPN – ПО для настройки VPN-тоннеля для подключения к ВМ. 
#### Установка openVPN для MacOS и Windows
1. Скачайте с сайта [openvpn.net](https://openvpn.net/client/) необходимый установочный файл.
2. Установите приложение
3. Возможно в брандмауэре Windows необходимо будет разрешить доступ для OpenVPN (галочки и для Private, и для Public сетей), а в MacOS нужно будет согласиться внести изменение в конфигурацию сети. Это может понадобиться при первом подключении
#### Установка на Linux
1. Выполните шаги по инструкции на [сайте](https://openvpn.net/community-docs/openvpn-client-for-linux.html)
### OpenVPN Config файл
1. Сохраните .ovpn-файл, который вам передал преподаватель, на компьютер
## Настройка соединения и подключение к ВМ
Для подключения нужно будет выполнить следующие шаги:
1. Подключение к vpn-тоннелю
2. Подключение к виртуальной машине в VS Code
### Подключение к тоннелю
#### MacOS, Windows (GUI)
1. Запустите OpenVPN Connect
2. File → Import → From local file → выберите .ovpn-файл, сохранённый на этапе подготовки к выполнению работы
3. Нажмите Connect
#### Linux (terminal)
1. Выполните команду ```sudo openvpn --config {путь к .ovpn-файлу}```
### Подключение к ВМ
Подключиться к ВМ по SSH можно с помощью пары логин-пароль и с помощью ssh-ключей. Ниже описаны оба способа, как это можно сделать. Для начала можно настроить подключение через логин, а затем добавить ключ и немного поменять конфиг.
#### Подключение с помощью пары логин-пароль
1. Перейдите в VS Code
2. В левом нижнем углу найдите иконку с двумя треугольными скобками "Open a Remote Window" (1 на скриншоте)
3. В появившемся меню выберите пункт "Connect to Host" (2 на скриншоте)
![начало подключения](./connect.png)
4. Если вы еще не настраивали подключение к этой ВМ, то выберите "Add New SSH Host"
![](./add.png)
5. В поле для ввода наберите ```ssh linux@<ip-адрес, указанный преподавателем>```
![](./ssh.png)
6. Далее выберите файл для конфигурации
![](./config.png)
7. В появившемся справа снизу уведомлении нажмите "открыть файл"
![](./notification.png)
8. Вы увидите заполненную конфигурацию
![](./config-file.png)
9. Проверьте, что конфигурация похожа на указанную ниже (вместо HOST может быть указан ip-адрес, можете изменить на человекочитаемое имя, в примере я указал se_labs_user). Убедитесь, что IP-адрес в HostName совпадает с переданным преподавателем
```
Host se_labs_user
  HostName <ip-адрес виртуальной машины>
  User linux
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null
```
10. Снова нажмите на иконку со скобками (как в п. 2)
11. Выберите "Connect to Host"
12. Выберите добавленный хост
13. Откроется новое окно VS Code с фиолетовой нижней панелью
![](./remote.png)
14. При запросе пароля введите переданный преподавателем пароль
15. Если все прошло корректно, то в файловом обозревателе вы увидите директории на виртуальной машине
#### Подключение через ssh
Для подключения с помощью ключей необходимо сгенерировать ключ на локальной машине, а затем публичную часть ключа добавить на сервер с ВМ. Ниже инструкции.
##### Linux/MacOS
1. Откройте терминал в VS Code (Terminal -> New Terminal)
2. Выполните команду ```ssh-keygen -t rsa -b 4096 -C "your_email@example.com"```
3. Укажите расположение ключа или сразу нажмите Enter для расположения по умолчанию (~/.ssh/id_rsa). Лучше указать расположение вручную и указать имя, чтобы не запутаться в ключах
4. Введите passphrase для установки кода для доступа к ключу или нажмите Enter (чтобы не вводить каждый раз)
5. Повторите passphare
6. Вы увидите, куда сохранился ключ
![](./ssh-keys.png)
Подробнее о настройке можно почитать в [статье](https://code.visualstudio.com/docs/remote/ssh#_remember-hosts-and-advanced-settings)

Теперь нам нужно скопировать публичный ключ на сервер с виртуальной машиной. Для этого:
1. Выполните команду ```ssh-copy-id -i <путь к публичному ключу из п.6 в пред-ем шаге> <логин>@<ip-адрес ВМ>```
  1. Если у вас Windows, то необходимо выполнить шаги ниже:
    1. Выполните команду ```type $env:USERPROFILE\<путь к публичному ключу>.pub```
    2. Подключитесь к ВИ, выполнив команду ```ssh linux@<ip-адрес ВМ>```
    3. Введите пароль, переданный преподавателем
    4. Создайте директорию, выполнив команду ```mkdir -p ~/.ssh```
    4. Добавьте публичный ключ с помощью команды ```echo "ВАШ_ПУБЛИЧНЫЙ_КЛЮЧ" >> ~/.ssh/authorized_keys```
    5. Поменяйте права доступа ```chmod 600 ~/.ssh/authorized_keys```
    6. Завершите подключение с помощью ```exit```
2. Введите пароль от ВМ, переданный преподавателем (НЕ Pass phrase из п.4 пред-го шага)
3. Если у вас MacOS, выполните команду ```ssh-add --apple-use-keychain <путь к публичному ключу из п.6 в пред-ем шаге>```
4. Если вы уже добавляли хост для подключения через логин пароль, то откройте конфигурационный файл
  1. Треугольные скобки
  2. Connect to Host
  3. Configure SSH Hosts
  4. Выберите конфигурационный файл, который настраивали
  5. Добавьте строку ```  IdentityFile <путь к ssh-ключу>```
В итоге ваш конфигурационный файл должен выглядеть так: 
```
Host se_labs_user
  HostName <ip-адрес виртуальной машины>
  User linux
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null
  IdentityFile <путь к ssh-ключу>
```
6. Готово, теперь вы можете подключаться без пароля с помощью ключа
🔗 Подробнее про настройку RemoteSSH: https://code.visualstudio.com/docs/remote/ssh
# ЧАВО (Часто Задаваемые Вопросы)
## OpenVPN
### OpenVPN не подключается / пишет "Connection timeout"
- Проверьте, что вы в той же сети, что и сервер
Убедитесь, что OpenVPN разрешен в брандмауэре
Попробуйте запустить OpenVPN от имени администратора
### VPN подключился, но не могу пингануть сервер
- Проверьте команду ipconfig (Windows) или ip a (Linux) — должен появиться адаптер с IP из диапазона 10.8.0.X
Попробуйте ping 192.168.2.1XX — если не работает, переподключите VPN
SSH подключение
### VSCode пишет "Permission denied (publickey,password)"
- Проверьте правильность пароля (должен быть linux)
Убедитесь, что VPN подключен
Проверьте правильность IP адреса хоста
### VSCode пишет "Connection timeout"
- Убедитесь, что OpenVPN успешно подключен
Проверьте правильность IP адреса (192.168.2.1XX)
Попробуйте пинговать хост: ping 192.168.2.1XX
### При подключении VSCode зависает на "Setting up SSH Host..."
- Нажмите Ctrl+C в терминале VSCode и попробуйте снова
Перезапустите VSCode
Удалите папку ~/.vscode-server на удаленном хосте (подключитесь через обычный терминал и выполните rm -rf ~/.vscode-server)
### SSH ключ не работает, все равно спрашивает пароль
- Проверьте права на файлы:
  - chmod 700 ~/.ssh
  - chmod 600 ~/.ssh/id_rsa
  - chmod 644 ~/.ssh/id_rsa.pub
- Убедитесь, что публичный ключ добавлен в ~/.ssh/authorized_keys на сервере
- Проверьте права на authorized_keys: chmod 600 ~/.ssh/authorized_keys
### Windows не видит команду ssh-keygen
- Используйте PowerShell вместо CMD
- Или установите Git Bash: https://git-scm.com/downloads
- Или обновите Windows до последней версии
### macOS просит пароль от ключа при каждом подключении
Выполните:
```ssh-add --apple-use-keychain ~/.ssh/id_rsa```
## Общие вопросы
### Забыл свой номер хоста (XX)
- Обратитесь к преподавателю
### Можно ли подключиться без VPN?
- Нет, сначала необходимо установить VPN соединение
### Можно ли использовать другой SSH клиент вместо VSCode?
- Да, можно использовать любой SSH клиент (PuTTY, встроенный ssh в терминале и т.д.), но для лабораторных работ рекомендуется VSCode, это поможет нам быстрее разобраться с ошибками и проблемами
### Как отключиться от хоста в VSCode?
- File → Close Remote Connection (или нажмите на зеленую кнопку в левом нижнем углу → Close Remote Connection)
### 💡 Не нашли ответ? 
- Обратитесь к преподавателю или в чат группы